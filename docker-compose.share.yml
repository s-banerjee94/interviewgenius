version: '3.8'

services:
  # ==========================================
  # Databases
  # ==========================================

  mysql:
    image: mysql:8.0
    container_name: interviewgenius-mysql
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_PASSWORD}
      MYSQL_DATABASE: interviewgenius_users
    volumes:
      - mysql-data:/var/lib/mysql
    networks:
      - interviewgenius-net
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-proot"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    restart: unless-stopped

  mongodb:
    image: mongo:7.0
    container_name: interviewgenius-mongodb
    volumes:
      - mongodb-data:/data/db
    networks:
      - interviewgenius-net
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    restart: unless-stopped

  # ==========================================
  # Infrastructure Services
  # ==========================================

  discovery-service:
    image: codewithsandy/interviewgenius-discovery:latest
    container_name: interviewgenius-discovery
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - EUREKA_INSTANCE_HOSTNAME=discovery-service
      - EUREKA_CLIENT_REGISTER_WITH_EUREKA=false
      - EUREKA_CLIENT_FETCH_REGISTRY=false
    networks:
      - interviewgenius-net
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8761/actuator/health"]
      interval: 15s
      timeout: 10s
      retries: 5
      start_period: 60s
    restart: unless-stopped

  gateway-service:
    image: codewithsandy/interviewgenius-gateway:latest
    container_name: interviewgenius-gateway
    ports:
      - "8080:8080"  # Only exposed port
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - EUREKA_DEFAULT_ZONE=http://discovery-service:8761/eureka/
      - JWT_SECRET=${JWT_SECRET}
      - JWT_ISSUER=${JWT_ISSUER}
      - JWT_AUDIENCE=${JWT_AUDIENCE}
      - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
      - GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET}
      - GITHUB_CLIENT_ID=${GITHUB_CLIENT_ID}
      - GITHUB_CLIENT_SECRET=${GITHUB_CLIENT_SECRET}
    depends_on:
      discovery-service:
        condition: service_healthy
    networks:
      - interviewgenius-net
    restart: unless-stopped

  # ==========================================
  # Business Services
  # ==========================================

  user-service:
    image: codewithsandy/interviewgenius-user:latest
    container_name: interviewgenius-user
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - DB_HOST=mysql
      - DB_PORT=3306
      - DB_NAME=interviewgenius_users
      - DB_USERNAME=${MYSQL_USERNAME}
      - DB_PASSWORD=${MYSQL_PASSWORD}
      - EUREKA_CLIENT_SERVICE_URL_DEFAULTZONE=http://discovery-service:8761/eureka/
    depends_on:
      mysql:
        condition: service_healthy
      discovery-service:
        condition: service_healthy
    networks:
      - interviewgenius-net
    restart: unless-stopped

  ai-service:
    image: codewithsandy/interviewgenius-ai:latest
    container_name: interviewgenius-ai
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - MYSQL_URL=jdbc:mysql://mysql:3306/interviewgenius_ai?createDatabaseIfNotExist=true&useSSL=false&allowPublicKeyRetrieval=true
      - MYSQL_USERNAME=${MYSQL_USERNAME}
      - MYSQL_PASSWORD=${MYSQL_PASSWORD}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - EUREKA_CLIENT_SERVICE_URL_DEFAULTZONE=http://discovery-service:8761/eureka/
      - INTERVIEW_PROMPT_PATH=file:/app/prompt/interview-chatclient-anthropic-1.st
      - RESUME_PROMPT_PATH=file:/app/prompt/resume-parser.st
    depends_on:
      mysql:
        condition: service_healthy
      discovery-service:
        condition: service_healthy
    networks:
      - interviewgenius-net
    restart: unless-stopped

  interview-service:
    image: codewithsandy/interviewgenius-interview:latest
    container_name: interviewgenius-interview
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - SPRING_DATA_MONGODB_URI=mongodb://mongodb:27017/interviewgenius
      - EUREKA_CLIENT_SERVICE_URL_DEFAULTZONE=http://discovery-service:8761/eureka/
    volumes:
      - interview-uploads:/app/uploads
    depends_on:
      mongodb:
        condition: service_healthy
      discovery-service:
        condition: service_healthy
    networks:
      - interviewgenius-net
    restart: unless-stopped

# ==========================================
# Networks
# ==========================================

networks:
  interviewgenius-net:
    driver: bridge
    name: interviewgenius-network

# ==========================================
# Volumes
# ==========================================

volumes:
  mysql-data:
    name: interviewgenius-mysql-data
  mongodb-data:
    name: interviewgenius-mongodb-data
  interview-uploads:
    name: interviewgenius-uploads
